<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æŸä¸ªäºŒç»´ç ç®¡ç†å·¥å…·</title>
    <!-- ä¾èµ–åº“ï¼šè¯·ç¡®ä¿åŒçº§ç›®å½•ä¸‹æœ‰è¿™ä¸¤ä¸ªæ–‡ä»¶ï¼Œæˆ–ä¿®æ”¹ä¸º CDN -->
    <script src="./vue.global.js"></script>
    <script src="./qrcode.min.js"></script>
    
    <style>
        :root {
            --primary: #3b82f6;
            --success: #10b981;
            --danger: #ef4444;
            --bg: #f3f4f6;
            --card-bg: #ffffff;
            --text: #1f2937;
            --text-light: #6b7280;
            --border: #e5e7eb;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg);
            color: var(--text);
            margin: 0;
            padding: 20px;
        }

        .container { max-width: 1200px; margin: 0 auto; }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            background: var(--card-bg);
            padding: 15px 20px;
            border-radius: 8px;
            box-shadow: 0 1px 2px rgba(0,0,0,0.05);
        }

        .header-actions { display: flex; gap: 10px; }

        .btn {
            padding: 8px 16px;
            border-radius: 6px;
            border: 1px solid transparent;
            cursor: pointer;
            font-weight: 500;
            transition: 0.2s;
            font-size: 0.9rem;
        }
        .btn-primary { background-color: var(--primary); color: white; }
        .btn-primary:hover { opacity: 0.9; }
        .btn-secondary { background-color: white; color: var(--text); border: 1px solid #d1d5db; }
        .btn-secondary:hover { background-color: #f9fafb; }
        .btn-danger { background-color: var(--danger); color: white; }
        .btn-ghost { background-color: transparent; color: var(--text-light); border: 1px solid #d1d5db; }

        /* Loading æç¤º */
        .loading-bar {
            background: #fffbe6; border: 1px solid #ffe58f; color: #d48806;
            padding: 10px; margin-bottom: 15px; border-radius: 6px; text-align: center;
            font-size: 0.9rem;
        }

        /* ç¼–è¾‘åŒº */
        .editor-panel {
            background: var(--card-bg);
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
            display: grid;
            gap: 15px;
            border: 1px solid var(--border);
        }

        .form-group label { display: block; margin-bottom: 5px; font-size: 0.9rem; color: var(--text-light); font-weight: 600; }
        .form-control {
            width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 6px; box-sizing: border-box; font-size: 1rem;
        }
        textarea.form-control { resize: vertical; min-height: 80px; }

        /* æœç´¢æ  */
        .search-bar { margin-bottom: 20px; display: flex; gap: 10px; }

        /* åˆ—è¡¨ç½‘æ ¼ */
        .grid {
            display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px;
        }

        .card {
            background: var(--card-bg); border-radius: 8px; padding: 15px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05); display: flex; flex-direction: column;
            transition: transform 0.2s; border: 1px solid var(--border);
        }
        .card:hover { transform: translateY(-2px); box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); }

        .card-header { display: flex; justify-content: space-between; align-items: start; margin-bottom: 10px; }
        
        .qr-container {
            display: flex; justify-content: center; margin: 10px 0; background: #fff;
            padding: 10px; border: 1px dashed #e5e7eb; border-radius: 4px;
        }
        .qr-code-canvas img { max-width: 100%; height: auto; }

        .tags { display: flex; flex-wrap: wrap; gap: 5px; margin-top: 10px; }
        .tag {
            background: #eff6ff; color: var(--primary); font-size: 0.75rem;
            padding: 2px 10px; border-radius: 99px; border: 1px solid #bfdbfe;
        }

        .card-actions {
            margin-top: auto; padding-top: 15px; display: flex; justify-content: flex-end;
            gap: 8px; border-top: 1px solid #f3f4f6;
        }

        .empty-state {
            text-align: center; padding: 60px; color: var(--text-light);
            background: white; border-radius: 8px; border: 1px dashed var(--border);
        }
        .text-sm { font-size: 0.875rem; } .text-xs { font-size: 0.75rem; }
        .truncate { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 180px; }
		/* é¡µå°¾æ ·å¼ */
		.footer {
			margin-top: 50px;
			padding-top: 20px;
			padding-bottom: 40px;
			text-align: center;
			color: var(--text-light);
			font-size: 0.9rem;
			border-top: 1px solid #e5e7eb;
			letter-spacing: 1px;
		}
    </style>
</head>
<body>

<div id="app" class="container">
    <!-- å¤´éƒ¨ -->
	<!-- <span class="text-sm text-light"></span><hr /> -->
    <div class="header">
        <div>
            <h2 style="margin:0">äºŒç»´ç ç®¡ç†å™¨</h2>
            <div class="text-xs text-light" style="margin-top: 5px;">
                <span v-if="isLoading" style="color: var(--primary)"> (æ­£åœ¨åŠ è½½é»˜è®¤æ•°æ®...)</span>
            </div>
        </div>
        
        <div class="header-actions">
            <input type="file" id="fileInput" accept=".json" @change="importData" style="display:none">
            
            <button class="btn btn-secondary" @click="resetToDefault" title="å¼ºåˆ¶é‡æ–°åŠ è½½é»˜è®¤é“¾æ¥çš„æ•°æ®">
                â†» é‡è½½é»˜è®¤
            </button>
            <button class="btn btn-secondary" @click="triggerImport">
                ğŸ“‚ å¯¼å…¥
            </button>
            <button class="btn btn-secondary" @click="exportData">
                ğŸ’¾ å¯¼å‡º
            </button>
            <button class="btn btn-primary" @click="toggleEditor" v-if="!showEditor">
                + æ–°å¢
            </button>
        </div>
    </div>

    <!-- æç¤ºæ  -->
    <div v-if="errorMsg" class="loading-bar" style="background:#fff2f0; border-color:#ffccc7; color:#ff4d4f;">
        {{ errorMsg }}
    </div>

    <!-- ç¼–è¾‘åŒº -->
    <div class="editor-panel" v-if="showEditor">
        <h3 style="margin:0">{{ isEditing ? 'ç¼–è¾‘äºŒç»´ç ' : 'åˆ›å»ºæ–°äºŒç»´ç ' }}</h3>
        <div class="form-group">
            <label>äºŒç»´ç å†…å®¹</label>
            <textarea v-model="form.content" class="form-control" placeholder="å¿…å¡«é¡¹ï¼Œä¾‹å¦‚ï¼šD1218"></textarea>
        </div>
        <div class="form-group">
            <label>å¤‡æ³¨/æè¿°</label>
            <input v-model="form.desc" class="form-control" placeholder="ä¾‹å¦‚: è›‹ç™½æå–é—´">
        </div>
        <div class="form-group">
            <label>æ ‡ç­¾</label>
            <input v-model="form.tagsInput" class="form-control" placeholder="ä¾‹å¦‚: æˆ¿é—´">
        </div>
        <div style="display:flex; gap:10px; justify-content:flex-end;">
            <button class="btn btn-ghost" @click="cancelEdit">å–æ¶ˆ</button>
            <button class="btn btn-primary" @click="saveItem" :disabled="!form.content">
                {{ isEditing ? 'ä¿å­˜' : 'ç”Ÿæˆ' }}
            </button>
        </div>
    </div>

    <!-- æœç´¢ä¸åˆ—è¡¨ -->
    <div class="search-bar">
        <input type="text" v-model="searchQuery" class="form-control" placeholder="æœç´¢...">
        <select v-model="filterTag" class="form-control" style="width: 150px;">
            <option value="">æ‰€æœ‰æ ‡ç­¾</option>
            <option v-for="tag in allTags" :value="tag">{{ tag }}</option>
        </select>
    </div>

    <div class="grid" v-if="filteredList.length > 0">
        <div class="card" v-for="item in filteredList" :key="item.id">
            <div class="card-header">
                <div>
                    <div style="font-weight:bold; font-size:1.05rem;">{{ item.desc || 'æ— æ ‡é¢˜' }}</div>
                    <div class="text-sm text-light truncate" :title="item.content">{{ item.content }}</div>
                </div>
            </div>
            <div class="qr-container">
                <img :src="item.qrImage" :alt="item.desc" style="width: 150px; height: 150px;">
            </div>
            <div class="tags">
                <span class="tag" v-for="tag in item.tags">{{ tag }}</span>
            </div>
            <div class="card-actions">
                <button class="btn btn-ghost text-sm" @click="downloadQR(item)">ä¿å­˜</button>
                <button class="btn btn-ghost text-sm" @click="editItem(item)">ç¼–è¾‘</button>
                <button class="btn btn-danger text-sm" @click="deleteItem(item.id)">åˆ é™¤</button>
            </div>
        </div>
    </div>

    <div class="empty-state" v-else>
        <p>æš‚æ— æ•°æ®ã€‚</p>
        <p class="text-sm">å¦‚æœé…ç½®äº†é»˜è®¤ JSON é“¾æ¥ï¼Œè¯·ç‚¹å‡»ã€â†» é‡è½½é»˜è®¤ã€‘å°è¯•æ‹‰å–ã€‚</p>
    </div>
	
	
	<!-- é¡µå°¾ -->
    <div class="footer">
        æ–°äºŒç»´ç å·¥å…·ï¼šç»ˆ
    </div>
</div>

<script>
    // ================= é…ç½®åŒºåŸŸ =================
    // åœ¨è¿™é‡Œå¡«å…¥ä½ çš„ JSON é»˜è®¤æ•°æ®é“¾æ¥
    // ç¤ºä¾‹ 1 (è¿œç¨‹): 'https://raw.githubusercontent.com/yourname/repo/main/data.json'
    // ç¤ºä¾‹ 2 (æœ¬åœ°æœåŠ¡å™¨): './init_data.json'
    const DEFAULT_JSON_URL = ''; 
    // ===========================================

    const { createApp, ref, computed, onMounted, watch } = Vue;

    createApp({
        setup() {
            const items = ref([]);
            const showEditor = ref(false);
            const isEditing = ref(false);
            const searchQuery = ref('');
            const filterTag = ref('');
            const isLoading = ref(false);
            const errorMsg = ref('');
            
            const form = ref({ id: null, content: '', desc: '', tagsInput: '' });

            // === æ ¸å¿ƒé€»è¾‘ï¼šæ•°æ®åŠ è½½ ===
            onMounted(async () => {
                const saved = localStorage.getItem('qr_manager_data');
                
                // 1. å¦‚æœæœ¬åœ°æœ‰æ•°æ®ï¼Œç›´æ¥ä½¿ç”¨
                if (saved) {
                    try {
                        const parsed = JSON.parse(saved);
                        if(parsed.length > 0) {
                            items.value = parsed;
                            return;
                        }
                    } catch(e) { console.error(e); }
                }

                // 2. å¦‚æœæœ¬åœ°æ²¡æ•°æ®ï¼ˆæˆ–æ•°æ®ä¸ºç©ºï¼‰ï¼Œä¸”é…ç½®äº† URLï¼Œåˆ™åŠ è½½é»˜è®¤
                if (DEFAULT_JSON_URL) {
                    await fetchDefaultData();
                }
            });

            // ä» URL è·å–æ•°æ®
            const fetchDefaultData = async () => {
                if (!DEFAULT_JSON_URL) {
                    errorMsg.value = "è¯·åœ¨ä»£ç ä¸­é…ç½® DEFAULT_JSON_URL å˜é‡";
                    return;
                }
                
                isLoading.value = true;
                errorMsg.value = '';
                try {
                    console.log(`æ­£åœ¨è·å–é»˜è®¤æ•°æ®: ${DEFAULT_JSON_URL}`);
                    const response = await fetch(DEFAULT_JSON_URL);
                    if (!response.ok) throw new Error(`HTTP Error: ${response.status}`);
                    
                    const data = await response.json();
                    if (Array.isArray(data)) {
                        items.value = data;
                        // è‡ªåŠ¨ä¿å­˜åˆ°æœ¬åœ°ï¼Œä¸‹æ¬¡å°±ä¸ç”¨åŠ è½½äº†
                        localStorage.setItem('qr_manager_data', JSON.stringify(data));
                    } else {
                        throw new Error("JSON æ ¼å¼é”™è¯¯ï¼šå¿…é¡»æ˜¯æ•°ç»„");
                    }
                } catch (err) {
                    console.error(err);
                    errorMsg.value = `åŠ è½½é»˜è®¤æ•°æ®å¤±è´¥: ${err.message} (è‹¥æ˜¯æœ¬åœ°æ–‡ä»¶è¯·ä½¿ç”¨ Web Server)`;
                } finally {
                    isLoading.value = false;
                }
            };

            // æŒ‰é’®ï¼šå¼ºåˆ¶é‡ç½®ä¸ºé»˜è®¤æ•°æ®
            const resetToDefault = async () => {
                if(confirm("ç¡®å®šè¦ä¸¢å¼ƒå½“å‰æ‰€æœ‰ä¿®æ”¹ï¼Œå¼ºåˆ¶é‡æ–°æ‹‰å–é»˜è®¤ JSON æ•°æ®å—ï¼Ÿ")) {
                    await fetchDefaultData();
                }
            };

            // ç›‘å¬ä¿å­˜
            watch(items, (newVal) => {
                localStorage.setItem('qr_manager_data', JSON.stringify(newVal));
            }, { deep: true });

            // === åŸºç¡€åŠŸèƒ½å‡½æ•° ===
            const generateQRBase64 = (text) => {
                return new Promise((resolve) => {
                    const div = document.createElement('div');
                    new QRCode(div, { text: text, width: 256, height: 256, correctLevel : QRCode.CorrectLevel.M });
                    setTimeout(() => {
                        const img = div.querySelector('img');
                        const canvas = div.querySelector('canvas');
                        if (img && img.src) resolve(img.src);
                        else if (canvas) resolve(canvas.toDataURL("image/png"));
                        else resolve('');
                    }, 50);
                });
            };

            const toggleEditor = () => { resetForm(); showEditor.value = true; isEditing.value = false; };
            const cancelEdit = () => { showEditor.value = false; resetForm(); };
            const resetForm = () => { form.value = { id: null, content: '', desc: '', tagsInput: '' }; };

            const saveItem = async () => {
                if (!form.value.content) return;
                const tags = form.value.tagsInput.split(/[,ï¼Œ]/).map(t => t.trim()).filter(t => t);
                const qrImage = await generateQRBase64(form.value.content);
                const newItem = {
                    id: form.value.id || Date.now().toString(),
                    content: form.value.content, desc: form.value.desc, tags: tags, qrImage: qrImage, updatedAt: Date.now()
                };
                if (isEditing.value) {
                    const index = items.value.findIndex(i => i.id === newItem.id);
                    if (index !== -1) items.value[index] = newItem;
                } else { items.value.unshift(newItem); }
                showEditor.value = false; resetForm();
            };

            const editItem = (item) => {
                form.value = { id: item.id, content: item.content, desc: item.desc, tagsInput: item.tags.join(', ') };
                isEditing.value = true; showEditor.value = true; window.scrollTo({ top: 0, behavior: 'smooth' });
            };

            const deleteItem = (id) => { if (confirm('ç¡®å®šåˆ é™¤ï¼Ÿ')) items.value = items.value.filter(i => i.id !== id); };

            const downloadQR = (item) => {
                const link = document.createElement('a');
                link.href = item.qrImage;
                link.download = `${(item.desc||'qr').replace(/[\\/:*?"<>|]/g, '_')}.png`;
                document.body.appendChild(link); link.click(); document.body.removeChild(link);
            };

            // å¯¼å…¥å¯¼å‡º
            const exportData = () => {
                if (items.value.length === 0) return alert("æ— æ•°æ®");
                const link = document.createElement('a');
                link.href = URL.createObjectURL(new Blob([JSON.stringify(items.value, null, 2)], { type: 'application/json' }));
                link.download = `QR_Backup_${new Date().toISOString().slice(0,10).replace(/-/g,'')}.json`;
                document.body.appendChild(link); link.click(); document.body.removeChild(link);
            };

            const triggerImport = () => document.getElementById('fileInput').click();
            const importData = (e) => {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (evt) => {
                    try {
                        const data = JSON.parse(evt.target.result);
                        if (Array.isArray(data) && confirm(`å¯¼å…¥ ${data.length} æ¡æ•°æ®ï¼Ÿ(å°†è¦†ç›–å½“å‰æ•°æ®)`)) items.value = data;
                    } catch(err) { alert("æ–‡ä»¶è§£æå¤±è´¥"); }
                    e.target.value = '';
                };
                reader.readAsText(file);
            };

            const allTags = computed(() => {
                const tags = new Set();
                items.value.forEach(item => item.tags.forEach(t => tags.add(t)));
                return Array.from(tags);
            });

            const filteredList = computed(() => {
                return items.value.filter(item => {
                    const q = searchQuery.value.toLowerCase();
                    return (
                        (item.content.toLowerCase().includes(q) || item.desc.toLowerCase().includes(q) || item.tags.some(t => t.toLowerCase().includes(q))) &&
                        (filterTag.value ? item.tags.includes(filterTag.value) : true)
                    );
                });
            });

            return {
                items, showEditor, isEditing, form, searchQuery, filterTag, isLoading, errorMsg,
                allTags, filteredList,
                toggleEditor, cancelEdit, saveItem, editItem, deleteItem, downloadQR,
                exportData, triggerImport, importData, resetToDefault // æ–°å¢æ–¹æ³•
            };
        }
    }).mount('#app');
</script>
</body>
</html>
