<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="referrer" content="no-referrer">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>抽你卡</title>
    
    <link rel="icon" href="https://www.pokemon.cn/favicon.ico" type="image/x-icon">
    <link rel="shortcut icon" href="https://www.pokemon.cn/favicon.ico" type="image/x-icon">

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>
    <style>
        body { background-color: #04060b; color: white; overflow-x: hidden; font-family: system-ui, -apple-system, sans-serif; }

        .bg-mesh {
            position: fixed; inset: 0;
            background: radial-gradient(circle at 10% 20%, #172554 0%, transparent 60%),
                        radial-gradient(circle at 90% 80%, #581c87 0%, transparent 60%);
            z-index: -1; opacity: 0.8;
        }

        /* --- 卡牌样式 --- */
        .card-container {
            perspective: 1200px;
            aspect-ratio: 2.5 / 3.5;
            width: 160px;
            flex-shrink: 0;
        }

        .card-inner {
            position: relative; width: 100%; height: 100%;
            transition: transform 0.6s cubic-bezier(0.2, 0.8, 0.2, 1);
            transform-style: preserve-3d; cursor: pointer;
        }

        .is-flipped { transform: rotateY(180deg); } /* 去掉了 scale，防止翻转时穿模 */

        .card-face {
            position: absolute; width: 100%; height: 100%;
            backface-visibility: hidden; border-radius: 4.5%;
            box-shadow: 0 8px 20px rgba(0,0,0,0.6); overflow: hidden;
        }

        .card-back {
            background-image: url('https://image.pokemon.com.cn/wp-content/uploads/2025/11/tcg-img-basic-3.png');
            background-size: 100% 100%; background-position: center; border: 1px solid #1e3a8a;
        }

        .card-front {
            transform: rotateY(180deg); background-color: #1a1c2c;
            display: flex; align-items: center; justify-content: center;
        }
        
        .card-front img { width: 100%; height: 100%; object-fit: fill; opacity: 0; transition: opacity 0.3s; }
        .card-front img.loaded { opacity: 1; }

        /* --- 稀有度与闪卡标签 --- */
        .rarity-badge {
            position: absolute; 
            bottom: 6px; right: 6px;
            font-size: 10px; font-weight: 900; 
            padding: 1px 6px; border-radius: 4px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.6); 
            z-index: 20; letter-spacing: 0.5px;
            text-shadow: 0 1px 2px rgba(0,0,0,0.3);
            pointer-events: none;
        }
        
        .bg-ar { background: linear-gradient(135deg, #d946ef, #8b5cf6); color: white; border: 1px solid rgba(255,255,255,0.4); }
        .bg-sar { background: linear-gradient(135deg, #fbbf24, #d97706); color: #fff; border: 1px solid rgba(255,255,255,0.6); box-shadow: 0 0 10px rgba(251, 191, 36, 0.4); }
        .bg-holo { background: linear-gradient(135deg, #3b82f6, #2563eb); color: white; border: 1px solid rgba(255,255,255,0.3); font-family: "Microsoft YaHei", sans-serif; }

        /* --- 闪卡流光特效 --- */
        .holo-effect {
            position: absolute; inset: 0; pointer-events: none;
            opacity: 0.6; 
            background: linear-gradient(115deg, 
                transparent 30%, 
                rgba(255,255,255,0.2) 45%, 
                rgba(255,255,255,0.6) 50%, 
                rgba(255,255,255,0.2) 55%, 
                transparent 70%);
            background-size: 250% 250%;
            mix-blend-mode: overlay; 
            animation: holoMove 3s infinite linear;
        }
        @keyframes holoMove { 0% { background-position: 200% 0; } 100% { background-position: -200% 0; } }

        /* 撕包动画 */
        .pack-shake { animation: shake 0.1s infinite; }
        @keyframes shake { 0% { transform: translate(1px, 1px); } 50% { transform: translate(-1px, -2px); } 100% { transform: translate(1px, -1px); } }
        .pack-tear-top { clip-path: polygon(0 0, 100% 0, 100% 22%, 0 22%); animation: tearTop 0.6s forwards cubic-bezier(0.2, 0.8, 0.2, 1); }
        @keyframes tearTop { 0% { transform: translateY(0) rotate(0); opacity: 1; } 100% { transform: translateY(-120px) rotate(-15deg); opacity: 0; } }
        .pack-tear-bottom { clip-path: polygon(0 22%, 100% 22%, 100% 100%, 0 100%); animation: tearBottom 0.6s forwards cubic-bezier(0.2, 0.8, 0.2, 1); }
        @keyframes tearBottom { 0% { transform: translateY(0); opacity: 1; } 100% { transform: translateY(100px) scale(0.9); opacity: 0; } }
        .flash-overlay { position: fixed; inset: 0; background: white; z-index: 50; pointer-events: none; animation: flash 0.8s forwards; }
        @keyframes flash { 0% { opacity: 0; } 50% { opacity: 1; } 100% { opacity: 0; } }

        /* 滑动条兼容 */
        input[type=range] { -webkit-appearance: none; width: 100%; background: transparent; }
        input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; height: 20px; width: 20px; border-radius: 50%; background: #facc15; cursor: pointer; margin-top: -8px; box-shadow: 0 0 10px rgba(250, 204, 21, 0.8); }
        input[type=range]::-webkit-slider-runnable-track { width: 100%; height: 4px; cursor: pointer; background: #475569; border-radius: 2px; }
        input[type=range]::-moz-range-thumb { height: 20px; width: 20px; border: none; border-radius: 50%; background: #facc15; cursor: pointer; }
        input[type=range]::-moz-range-track { width: 100%; height: 4px; cursor: pointer; background: #475569; border-radius: 2px; }
        input[type=number]::-webkit-inner-spin-button, input[type=number]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
        input[type=number] { -moz-appearance: textfield; }

        /* === 核心新增：全屏查看器动画 === */
        .zoom-enter-active, .zoom-leave-active { transition: opacity 0.3s ease; }
        .zoom-enter-from, .zoom-leave-to { opacity: 0; }
        
        .zoom-card-enter-active, .zoom-card-leave-active { transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        .zoom-card-enter-from, .zoom-card-leave-to { transform: scale(0.5); opacity: 0; }
    </style>
</head>
<body>

<div id="app" class="min-h-screen flex flex-col items-center justify-center p-4">
    <div class="bg-mesh"></div>
    <div v-if="showFlash" class="flash-overlay"></div>

    <!-- ==================== 全屏查看器 (新增) ==================== -->
    <transition name="zoom">
        <div v-if="zoomedCard" class="fixed inset-0 z-[100] flex items-center justify-center bg-black/80 backdrop-blur-md p-4" @click="zoomedCard = null">
            <transition name="zoom-card" appear>
                <!-- 放大后的卡牌容器 -->
                <div class="relative w-full max-w-sm aspect-[2.5/3.5] rounded-xl overflow-hidden shadow-2xl cursor-zoom-out border border-white/20" @click.stop="zoomedCard = null">
                    <!-- 图片 -->
                    <img :src="zoomedCard.url" class="w-full h-full object-fill">
                    
                    <!-- 标签 (放大时也显示) -->
                    <div v-if="zoomedCard.suffix === 'a'" class="rarity-badge bg-ar !text-sm !px-3 !py-1 !bottom-4 !right-4">AR</div>
                    <div v-else-if="zoomedCard.suffix === 'b'" class="rarity-badge bg-sar !text-sm !px-3 !py-1 !bottom-4 !right-4">SAR</div>
                    <div v-else-if="zoomedCard.isHolo" class="rarity-badge bg-holo !text-sm !px-3 !py-1 !bottom-4 !right-4">闪</div>

                    <!-- 闪光特效 (放大时更明显) -->
                    <div v-if="zoomedCard.isHolo || zoomedCard.suffix" class="holo-effect !opacity-40"></div>
                </div>
            </transition>
            <!-- 提示文字 -->
            <div class="absolute bottom-10 text-white/50 text-sm pointer-events-none">点击任意处关闭</div>
        </div>
    </transition>
    <!-- ========================================================= -->

    <!-- 1. 选包界面 -->
    <div v-if="view === 'SELECT'" class="w-full max-w-5xl animate__animated animate__fadeIn">
        <h1 class="text-4xl md:text-5xl font-black italic text-center mb-4 tracking-tighter text-white drop-shadow-lg">
            选择你的 <span class="text-yellow-400">扩展包</span>
        </h1>
        <p class="text-center text-blue-300 mb-12 font-bold tracking-widest text-sm invisible select-none">抽你卡</p>
        
        <div class="flex flex-wrap justify-center gap-8 md:gap-16 px-4">
            <div v-for="p in packs" :key="p.id" @click="selectPack(p)" 
                 class="cursor-pointer group relative transition-transform duration-300 hover:scale-105 active:scale-95">
                <img :src="p.img" class="w-48 md:w-56 drop-shadow-2xl">
                <div class="absolute inset-0 bg-white/20 blur-xl opacity-0 group-hover:opacity-100 transition-opacity rounded-full"></div>
            </div>
        </div>
    </div>

    <!-- 2. 开包设置界面 -->
    <div v-if="view === 'OPENING'" class="w-full flex flex-col items-center">
        
        <!-- 待撕开 -->
        <div v-if="!isRipped" class="relative flex flex-col items-center w-full max-w-md animate__animated animate__zoomIn">
            <div class="relative w-56 md:w-64 aspect-[2/3.5] cursor-pointer" @click="ripAction">
                <img v-if="!isTearing" :src="activePack.img" class="w-full h-full object-contain absolute inset-0 z-10 transition-transform hover:scale-105" :class="{'pack-shake': isVibrating}">
                <div v-else class="w-full h-full absolute inset-0 z-20">
                    <img :src="activePack.img" class="w-full h-full object-contain absolute inset-0 pack-tear-top">
                    <img :src="activePack.img" class="w-full h-full object-contain absolute inset-0 pack-tear-bottom">
                </div>
            </div>
            
            <div v-if="!isTearing" class="mt-6 bg-slate-900/90 backdrop-blur-md p-6 rounded-2xl border border-slate-700 w-full shadow-2xl transition-opacity duration-300" :class="{'opacity-0': isVibrating}">
                
                <div class="flex justify-between items-end mb-2">
                    <span class="text-xs font-bold text-slate-400 uppercase">抽卡数量</span>
                    <span class="text-2xl font-black text-yellow-400">{{ drawCount }}</span>
                </div>
                <input type="range" v-model.number="drawCount" min="1" max="20" step="1" class="mb-6">
                
                <div class="grid grid-cols-2 gap-4 mb-6">
                    <div class="bg-slate-800 p-2 rounded-lg border border-pink-900/50">
                        <label class="block text-[10px] text-pink-400 font-bold uppercase mb-1">AR 概率 (%)</label>
                        <input type="number" v-model.number="probAR" min="0" max="100" class="w-full bg-slate-700 border border-slate-600 rounded px-2 py-1 text-white text-center font-mono outline-none">
                    </div>
                    <div class="bg-slate-800 p-2 rounded-lg border border-yellow-900/50">
                        <label class="block text-[10px] text-yellow-400 font-bold uppercase mb-1">SAR 概率 (%)</label>
                        <input type="number" v-model.number="probSAR" min="0" max="100" class="w-full bg-slate-700 border border-slate-600 rounded px-2 py-1 text-white text-center font-mono outline-none">
                    </div>
                </div>

                <div class="flex items-center justify-between mb-6 bg-slate-800 p-3 rounded-xl border border-slate-700 overflow-visible">
                    <div class="flex items-center gap-2">
                        <img src="https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/other/dream-world/25.svg" 
                             class="w-14 h-14 object-contain drop-shadow-md">
                        <div class="flex flex-col">
                            <span class="text-sm font-bold text-white">必出皮卡丘</span>
                            <span class="text-[10px] text-slate-400 mt-0.5">其中一张必定是皮卡超</span>
                        </div>
                    </div>
                    <label class="relative inline-flex items-center cursor-pointer flex-shrink-0">
                        <input type="checkbox" v-model="guaranteePikachu" class="sr-only peer">
                        <div class="w-11 h-6 bg-gray-600 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-yellow-400 shadow-inner"></div>
                    </label>
                </div>

                <div class="flex justify-between gap-2 mb-4">
                    <button @click="drawCount=1" class="flex-1 py-2 bg-slate-800 hover:bg-slate-700 rounded-lg text-xs font-bold transition">单抽</button>
                    <button @click="drawCount=5" class="flex-1 py-2 bg-slate-800 hover:bg-slate-700 rounded-lg text-xs font-bold transition">5连</button>
                    <button @click="drawCount=10" class="flex-1 py-2 bg-slate-800 hover:bg-slate-700 rounded-lg text-xs font-bold transition">10连</button>
                </div>

                <div class="flex gap-3">
                    <button @click="view = 'SELECT'" class="w-1/3 bg-slate-700 hover:bg-slate-600 text-white py-3 rounded-xl font-bold transition active:scale-95">返回</button>
                    <button @click="ripAction" class="w-2/3 bg-blue-600 hover:bg-blue-500 text-white py-3 rounded-xl font-black text-lg transition shadow-lg active:scale-95">立即撕开</button>
                </div>
            </div>
        </div>

        <!-- 3. 卡牌展示区 -->
        <div v-if="isRipped" class="w-full px-2 animate__animated animate__fadeInUp">
            <div class="flex flex-col md:flex-row justify-between items-center max-w-6xl mx-auto mb-6 gap-4">
                <h2 class="text-xl font-bold text-slate-300">获得 {{ currentCards.length }} 张卡牌</h2>
                <div class="flex gap-4">
                    <button v-if="!allRevealed" @click="revealAll" class="text-xs bg-slate-800 px-4 py-2 rounded-full hover:bg-slate-700 font-bold border border-slate-600">全部翻开</button>
                    <button @click="selectPack(activePack)" class="text-xs bg-blue-600 px-4 py-2 rounded-full hover:bg-blue-500 font-bold">返回</button>
                </div>
            </div>

            <div class="grid gap-3 md:gap-4 max-w-7xl mx-auto pb-24 justify-items-center transition-all duration-500" :class="layoutClass">
                <div v-for="(card, i) in currentCards" :key="i" class="card-container">
                    <!-- 核心修改：@click 逻辑 -->
                    <div class="card-inner" :class="{'is-flipped': card.revealed}" @click="handleCardClick(card)">
                        <div class="card-face card-back"></div>
                        <div class="card-face card-front relative">
                            <div v-if="!card.isLoaded" class="loading-pulse"></div>
                            
                            <div v-if="card.suffix === 'a'" class="rarity-badge bg-ar">AR</div>
                            <div v-else-if="card.suffix === 'b'" class="rarity-badge bg-sar">SAR</div>
                            <div v-else-if="card.isHolo" class="rarity-badge bg-holo">闪</div>

                            <img :src="card.url" :class="{ 'loaded': card.isLoaded }" @load="card.isLoaded = true" @error="handleError(card)">
                            
                            <div v-if="card.isHolo || card.suffix" class="holo-effect"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="fixed bottom-6 left-0 right-0 flex justify-center z-50 pointer-events-none">
                <button v-if="allRevealed" @click="view = 'SELECT'" 
                        class="bg-yellow-400 text-black px-8 py-2 rounded-full font-bold text-base shadow-[0_10px_30px_rgba(250,204,21,0.5)] hover:scale-105 transition-all pointer-events-auto cursor-pointer border-2 border-yellow-500">
                    继续
                </button>
            </div>
        </div>
    </div>
</div>

<script>
    const { createApp, ref, computed } = Vue;

    createApp({
        setup() {
            const view = ref('SELECT');
            const isVibrating = ref(false);
            const isTearing = ref(false); 
            const isRipped = ref(false);
            const showFlash = ref(false); 
            const activePack = ref(null);
            const currentCards = ref([]);
            
            // 新增：放大的卡片数据
            const zoomedCard = ref(null);
            
            const drawCount = ref(10); 
            const guaranteePikachu = ref(false); 
            const probAR = ref(10); 
            const probSAR = ref(2);

            const packs = [
                { id: '151-1', img: 'https://image.pokemon.com.cn/wp-content/uploads/2025/09/accb6c04e358f172fffdc6ea0a0e77c40d1f64b0-scaled.png' },
                { id: '151-2', img: 'https://image.pokemon.com.cn/wp-content/uploads/2025/09/2b62dd5a724064a784b7b76a67231c7a795febcd-scaled.png' },
                { id: 'gem', img: 'https://image.pokemon.com.cn/wp-content/uploads/2025/01/151_5_1_5-effect-picture-thumb-600xauto-26551.png' }
            ];

            const layoutClass = computed(() => {
                const count = currentCards.value.length;
                if (count === 10) return 'grid-cols-2 md:grid-cols-5';
                if (count === 9) return 'grid-cols-3 md:grid-cols-3';
                if (count === 5) return 'grid-cols-3 md:grid-cols-5';
                if (count <= 4) return 'grid-cols-2 md:grid-cols-4';
                return 'grid-cols-3 md:grid-cols-4 lg:grid-cols-5';
            });

            const selectPack = (pack) => {
                activePack.value = pack;
                view.value = 'OPENING';
                isRipped.value = false;
                isTearing.value = false;
                isVibrating.value = false;
                showFlash.value = false;
                currentCards.value = [];
                zoomedCard.value = null;
            };

            const ripAction = () => {
                if (isVibrating.value || isTearing.value) return;
                isVibrating.value = true;
                
                const cards = [];
                let pikachuIndex = -1;
                if (guaranteePikachu.value) pikachuIndex = Math.floor(Math.random() * drawCount.value);
                const rateSAR = probSAR.value / 100;
                const rateAR = probAR.value / 100;

                for(let i=0; i<drawCount.value; i++) {
                    let id;
                    if (i === pikachuIndex) id = 25; 
                    else id = Math.floor(Math.random() * 151) + 1;

                    const padId = String(id).padStart(3, '0');
                    const rand = Math.random();
                    let suffix = '';
                    let isHolo = false;

                    if (rand < rateSAR) { suffix = 'b'; isHolo = true; } 
                    else if (rand < (rateSAR + rateAR)) { suffix = 'a'; isHolo = true; } 
                    else { suffix = ''; isHolo = id === 25 ? true : Math.random() > 0.8; }

                    const url = `https://special.pokemon.cn/151/img/big/151_${padId}${suffix}.png`;
                    cards.push({ id: padId, suffix, url, revealed: false, isLoaded: false, isHolo });
                }
                currentCards.value = cards;
                cards.forEach(c => { const img = new Image(); img.src = c.url; });

                setTimeout(() => {
                    isVibrating.value = false;
                    isTearing.value = true; 
                    setTimeout(() => {
                        showFlash.value = true;
                        setTimeout(() => {
                            isRipped.value = true;
                            showFlash.value = false;
                        }, 400);
                    }, 400);
                }, 600);
            };

            // 核心修改：点击逻辑
            const handleCardClick = (card) => {
                if (!card.revealed) {
                    // 如果没翻开，翻开它
                    card.revealed = true;
                } else {
                    // 如果已经翻开，放大显示
                    zoomedCard.value = card;
                }
            };

            const revealAll = () => { currentCards.value.forEach(c => c.revealed = true); };

            const handleError = (card) => {
                const baseUrl = `https://special.pokemon.cn/151/img/big/151_${card.id}`;
                if (card.suffix === 'b') { card.suffix = 'a'; card.url = `${baseUrl}a.png`; } 
                else if (card.suffix === 'a') { card.suffix = ''; card.url = `${baseUrl}.png`; } 
                else { card.url = 'https://special.pokemon.cn/151/img/big/151_001.png'; }
            };

            const allRevealed = computed(() => {
                return currentCards.value.length > 0 && currentCards.value.every(c => c.revealed);
            });

            return { 
                view, packs, activePack, currentCards, drawCount, guaranteePikachu,
                probAR, probSAR, isTearing, showFlash, layoutClass, zoomedCard,
                selectPack, ripAction, revealAll, handleError, handleCardClick,
                isVibrating, isRipped, allRevealed 
            };
        }
    }).mount('#app');
</script>

</body>
</html>