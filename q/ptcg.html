<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="referrer" content="no-referrer">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>抽你卡 - 自定义概率版</title>
    
    <link rel="icon" href="https://www.pokemon.cn/favicon.ico" type="image/x-icon">
    <link rel="shortcut icon" href="https://www.pokemon.cn/favicon.ico" type="image/x-icon">

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>
    <style>
        body { background-color: #04060b; color: white; overflow-x: hidden; font-family: system-ui, -apple-system, sans-serif; }

        /* 背景特效 */
        .bg-mesh {
            position: fixed; inset: 0;
            background: radial-gradient(circle at 10% 20%, #172554 0%, transparent 60%),
                        radial-gradient(circle at 90% 80%, #581c87 0%, transparent 60%);
            z-index: -1; opacity: 0.8;
        }

        /* 卡牌容器 */
        .card-container {
            perspective: 1200px;
            aspect-ratio: 2.5 / 3.5;
            width: 160px;
            flex-shrink: 0;
        }

        .card-inner {
            position: relative; width: 100%; height: 100%;
            transition: transform 0.6s cubic-bezier(0.2, 0.8, 0.2, 1);
            transform-style: preserve-3d; cursor: pointer;
        }

        .is-flipped { transform: rotateY(180deg) scale(1.05); }

        .card-face {
            position: absolute; width: 100%; height: 100%;
            backface-visibility: hidden; border-radius: 4.5%;
            box-shadow: 0 8px 20px rgba(0,0,0,0.6); overflow: hidden;
        }

        .card-back {
            background-image: url('https://image.pokemon.com.cn/wp-content/uploads/2025/11/tcg-img-basic-3.png');
            background-size: 100% 100%; background-position: center; border: 1px solid #1e3a8a;
        }

        .card-front {
            transform: rotateY(180deg); background-color: #1a1c2c;
            display: flex; align-items: center; justify-content: center;
        }
        
        .card-front img { width: 100%; height: 100%; object-fit: fill; opacity: 0; transition: opacity 0.3s; }
        .card-front img.loaded { opacity: 1; }

        /* 稀有度标签 */
        .rarity-badge {
            position: absolute; bottom: 5px; right: 5px;
            font-size: 10px; font-weight: bold; padding: 2px 6px; border-radius: 4px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.5); z-index: 10;
        }
        .bg-ar { background: linear-gradient(45deg, #ec4899, #8b5cf6); color: white; }
        .bg-sar { background: linear-gradient(45deg, #fbbf24, #f59e0b, #d97706); color: black; border: 1px solid white; }

        /* 滑动条样式 */
        input[type=range] {
            -webkit-appearance: none; width: 100%; background: transparent;
        }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none; height: 20px; width: 20px;
            border-radius: 50%; background: #facc15; cursor: pointer; margin-top: -8px;
            box-shadow: 0 0 10px rgba(250, 204, 21, 0.8);
        }
        input[type=range]::-webkit-slider-runnable-track {
            width: 100%; height: 4px; cursor: pointer; background: #475569; border-radius: 2px;
        }

        /* 数字输入框去箭头 */
        input[type=number]::-webkit-inner-spin-button, 
        input[type=number]::-webkit-outer-spin-button { 
            -webkit-appearance: none; margin: 0; 
        }

        .pack-vibrate { animation: vibrate 0.1s infinite; }
        @keyframes vibrate { 0% { transform: translate(1px, 1px); } 50% { transform: translate(-1px, -2px); } 100% { transform: translate(1px, -1px); } }
        
        .holo-effect {
            position: absolute; inset: 0; pointer-events: none; opacity: 0; transition: opacity 0.3s;
            background: linear-gradient(115deg, transparent 20%, rgba(255,255,255,0.4) 40%, rgba(255,255,255,0.6) 50%, rgba(255,255,255,0.4) 60%, transparent 80%);
            background-size: 200% 200%; mix-blend-mode: overlay;
        }
        .card-inner:hover .holo-effect { opacity: 1; animation: holoMove 2.5s infinite linear; }
        @keyframes holoMove { 0% { background-position: 200% 0; } 100% { background-position: -200% 0; } }
    </style>
</head>
<body>

<div id="app" class="min-h-screen flex flex-col items-center justify-center p-4">
    <div class="bg-mesh"></div>

    <!-- 1. 选包界面 -->
    <div v-if="view === 'SELECT'" class="w-full max-w-5xl animate__animated animate__fadeIn">
        <h1 class="text-4xl md:text-5xl font-black italic text-center mb-4 tracking-tighter text-white drop-shadow-lg">
            选择你的 <span class="text-yellow-400">扩展包</span>
        </h1>
        <p class="text-center text-blue-300 mb-12 font-bold tracking-widest text-sm">自定义概率版</p>
        
        <div class="flex flex-wrap justify-center gap-8 md:gap-16 px-4">
            <div v-for="p in packs" :key="p.id" @click="selectPack(p)" 
                 class="cursor-pointer group relative transition-transform duration-300 hover:scale-105 active:scale-95">
                <img :src="p.img" class="w-48 md:w-56 drop-shadow-2xl">
                <div class="absolute inset-0 bg-white/20 blur-xl opacity-0 group-hover:opacity-100 transition-opacity rounded-full"></div>
            </div>
        </div>
    </div>

    <!-- 2. 开包设置界面 -->
    <div v-if="view === 'OPENING'" class="w-full flex flex-col items-center">
        <!-- 待撕开的卡包 -->
        <div v-if="!isRipped" class="flex flex-col items-center w-full max-w-md animate__animated animate__zoomIn">
            <img :src="activePack.img" class="w-56 md:w-64 transition-transform hover:scale-105 cursor-pointer" 
                 :class="{'pack-vibrate': isVibrating}" @click="ripAction">
            
            <!-- 设置面板 -->
            <div class="mt-6 bg-slate-900/90 backdrop-blur-md p-6 rounded-2xl border border-slate-700 w-full shadow-2xl">
                
                <!-- 数量选择 -->
                <div class="flex justify-between items-end mb-2">
                    <span class="text-xs font-bold text-slate-400 uppercase">抽卡数量</span>
                    <span class="text-2xl font-black text-yellow-400">{{ drawCount }}</span>
                </div>
                <input type="range" v-model.number="drawCount" min="1" max="20" step="1" class="mb-6">
                
                <!-- 新增：概率自定义区 -->
                <div class="grid grid-cols-2 gap-4 mb-6">
                    <div class="bg-slate-800 p-2 rounded-lg border border-pink-900/50">
                        <label class="block text-[10px] text-pink-400 font-bold uppercase mb-1">AR 概率 (%)</label>
                        <input type="number" v-model.number="probAR" min="0" max="100" class="w-full bg-slate-700 border border-slate-600 rounded px-2 py-1 text-white text-center font-mono focus:outline-none focus:border-pink-500">
                    </div>
                    <div class="bg-slate-800 p-2 rounded-lg border border-yellow-900/50">
                        <label class="block text-[10px] text-yellow-400 font-bold uppercase mb-1">SAR 概率 (%)</label>
                        <input type="number" v-model.number="probSAR" min="0" max="100" class="w-full bg-slate-700 border border-slate-600 rounded px-2 py-1 text-white text-center font-mono focus:outline-none focus:border-yellow-500">
                    </div>
                </div>

                <!-- 必出皮卡丘开关 -->
                <div class="flex items-center justify-between mb-6 bg-slate-800 p-3 rounded-xl border border-slate-700">
                    <div class="flex items-center gap-2">
                        <span class="text-xl">⚡</span>
                        <div class="flex flex-col">
                            <span class="text-xs font-bold text-white">必出皮卡丘</span>
                            <span class="text-[10px] text-slate-400">其中一张必定是皮卡超</span>
                        </div>
                    </div>
                    <label class="relative inline-flex items-center cursor-pointer">
                        <input type="checkbox" v-model="guaranteePikachu" class="sr-only peer">
                        <div class="w-11 h-6 bg-gray-600 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-yellow-400"></div>
                    </label>
                </div>

                <!-- 快捷按钮 -->
                <div class="flex justify-between gap-2">
                    <button @click="drawCount=1" class="flex-1 py-2 bg-slate-800 hover:bg-slate-700 rounded-lg text-xs font-bold transition">单抽</button>
                    <button @click="drawCount=5" class="flex-1 py-2 bg-slate-800 hover:bg-slate-700 rounded-lg text-xs font-bold transition">5连</button>
                    <button @click="drawCount=10" class="flex-1 py-2 bg-slate-800 hover:bg-slate-700 rounded-lg text-xs font-bold transition">10连</button>
                </div>

                <button @click="ripAction" class="w-full mt-6 bg-blue-600 hover:bg-blue-500 text-white py-3 rounded-xl font-black text-lg transition shadow-lg active:scale-95">
                    立即撕开
                </button>
            </div>
        </div>

        <!-- 3. 卡牌展示区 -->
        <div v-if="isRipped" class="w-full px-4 animate__animated animate__fadeInUp">
            <div class="flex justify-between items-center max-w-6xl mx-auto mb-6">
                <h2 class="text-xl font-bold text-slate-300">获得 {{ currentCards.length }} 张卡牌</h2>
                <div class="flex gap-4">
                    <button v-if="!allRevealed" @click="revealAll" class="text-xs bg-slate-800 px-4 py-2 rounded-full hover:bg-slate-700 font-bold border border-slate-600">全部翻开</button>
                </div>
            </div>

            <!-- 弹性布局 -->
            <div class="flex flex-wrap justify-center gap-4 max-w-[1400px] mx-auto pb-20">
                <div v-for="(card, i) in currentCards" :key="i" class="card-container">
                    <div class="card-inner" :class="{'is-flipped': card.revealed}" @click="card.revealed = true">
                        <div class="card-face card-back"></div>
                        <div class="card-face card-front">
                            <div v-if="!card.isLoaded" class="loading-pulse"></div>
                            
                            <!-- 异画标记 -->
                            <div v-if="card.suffix === 'a'" class="rarity-badge bg-ar">AR</div>
                            <div v-if="card.suffix === 'b'" class="rarity-badge bg-sar">SAR</div>

                            <img :src="card.url" :class="{ 'loaded': card.isLoaded }" @load="card.isLoaded = true" @error="handleError(card)">
                            <!-- 异画卡必有闪光 -->
                            <div v-if="card.isHolo || card.suffix" class="holo-effect"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="fixed bottom-6 left-0 right-0 flex justify-center z-50 pointer-events-none">
                <button v-if="allRevealed" @click="view = 'SELECT'" 
                        class="bg-yellow-400 text-black px-12 py-3 rounded-full font-black text-lg shadow-[0_10px_30px_rgba(250,204,21,0.5)] hover:scale-105 transition-all pointer-events-auto cursor-pointer">
                    继续
                </button>
            </div>
        </div>
    </div>
</div>

<script>
    const { createApp, ref, computed } = Vue;

    createApp({
        setup() {
            const view = ref('SELECT');
            const isVibrating = ref(false);
            const isRipped = ref(false);
            const activePack = ref(null);
            const currentCards = ref([]);
            
            const drawCount = ref(10); 
            const guaranteePikachu = ref(false); 
            
            // 新增：概率状态
            const probAR = ref(10); // 默认 10%
            const probSAR = ref(2); // 默认 2%

            const packs = [
                { id: '151-1', img: 'https://image.pokemon.com.cn/wp-content/uploads/2025/09/accb6c04e358f172fffdc6ea0a0e77c40d1f64b0-scaled.png' },
                { id: '151-2', img: 'https://image.pokemon.com.cn/wp-content/uploads/2025/09/2b62dd5a724064a784b7b76a67231c7a795febcd-scaled.png' },
                { id: 'gem', img: 'https://image.pokemon.com.cn/wp-content/uploads/2025/01/151_5_1_5-effect-picture-thumb-600xauto-26551.png' }
            ];

            const selectPack = (pack) => {
                activePack.value = pack;
                view.value = 'OPENING';
                isRipped.value = false;
                drawCount.value = 10;
                guaranteePikachu.value = false;
                currentCards.value = [];
            };

            const ripAction = () => {
                if (isVibrating.value) return;
                isVibrating.value = true;
                
                const cards = [];
                let pikachuIndex = -1;
                if (guaranteePikachu.value) {
                    pikachuIndex = Math.floor(Math.random() * drawCount.value);
                }

                // 将输入的 0-100 转换为 0-1 的比率
                const rateSAR = probSAR.value / 100;
                const rateAR = probAR.value / 100;

                for(let i=0; i<drawCount.value; i++) {
                    let id;
                    if (i === pikachuIndex) {
                        id = 25; 
                    } else {
                        id = Math.floor(Math.random() * 151) + 1;
                    }

                    const padId = String(id).padStart(3, '0');
                    
                    // --- 动态概率逻辑 ---
                    const rand = Math.random();
                    let suffix = '';
                    let isHolo = false;

                    // 优先级：SAR > AR > 普通
                    if (rand < rateSAR) { 
                        // 中了 SAR
                        suffix = 'b'; 
                        isHolo = true;
                    } else if (rand < (rateSAR + rateAR)) {
                        // 没中 SAR 但中了 AR
                        suffix = 'a'; 
                        isHolo = true;
                    } else {
                        // 普通卡
                        suffix = '';
                        isHolo = id === 25 ? true : Math.random() > 0.8; 
                    }

                    const url = `https://static.campaignchowsangsang.com/pokemon/151/big/151_${padId}${suffix}.png`;

                    cards.push({
                        id: padId,
                        suffix: suffix, 
                        url: url,
                        revealed: false,
                        isLoaded: false,
                        isHolo: isHolo
                    });
                }
                currentCards.value = cards;

                cards.forEach(c => { const img = new Image(); img.src = c.url; });

                setTimeout(() => {
                    isVibrating.value = false;
                    isRipped.value = true;
                }, 600);
            };

            const revealAll = () => {
                currentCards.value.forEach(c => c.revealed = true);
            };

            const handleError = (card) => {
                const baseUrl = `https://static.campaignchowsangsang.com/pokemon/151/big/151_${card.id}`;
                
                if (card.suffix === 'b') {
                    // SAR 挂了，退到 AR
                    card.suffix = 'a';
                    card.url = `${baseUrl}a.png`;
                } else if (card.suffix === 'a') {
                    // AR 挂了，退到普通
                    card.suffix = '';
                    card.url = `${baseUrl}.png`;
                } else {
                    card.url = 'https://static.campaignchowsangsang.com/pokemon/151/big/151_001.png';
                }
            };

            const allRevealed = computed(() => {
                return currentCards.value.length > 0 && currentCards.value.every(c => c.revealed);
            });

            return { 
                view, packs, activePack, currentCards, drawCount, guaranteePikachu,
                probAR, probSAR, // 暴露新变量
                selectPack, ripAction, revealAll, handleError, 
                isVibrating, isRipped, allRevealed 
            };
        }
    }).mount('#app');
</script>

</body>
</html>